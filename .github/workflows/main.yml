name: Shopfront CI/CD

on:
  workflow_dispatch:
    inputs:
      APP_NAME:
        description: 'Application Name (shopfront, productcatalogue, etc.)'
        required: true
        default: 'shopfront'
      action:
        description: 'create or delete'
        required: true
        default: 'create'
      ImageTag:
        description: 'Docker image tag'
        required: true
        default: 'latest'
      DockerHubUser:
        description: 'Docker Hub username'
        required: true
        default: 'N/A'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2Ô∏è‚É£ Set up Java 8 + Maven cache
      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8.0.362'  # Java 8 full version
          distribution: 'temurin'
          cache: maven

      # 3Ô∏è‚É£ Maven build + unit tests
      - name: Maven Build + Unit Tests
        working-directory: ${{ github.event.inputs.APP_NAME }}
        run: mvn -B clean verify -DskipITs=true

      # 4Ô∏è‚É£ Maven Integration Test (Failsafe)
      - name: Maven Integration Tests
        if: ${{ github.event.inputs.action == 'create' }}
        working-directory: ${{ github.event.inputs.APP_NAME }}
        run: mvn -B clean verify -DskipUnitTests

      # 5Ô∏è‚É£ SonarQube static code analysis
      - name: SonarQube Scan
        if: ${{ github.event.inputs.action == 'create' }}
        working-directory: ${{ github.event.inputs.APP_NAME }}
        run: mvn sonar:sonar -Dsonar.login=${{ secrets.SONARQUBE_TOKEN }}

      # 6Ô∏è‚É£ Docker build
      - name: Docker Build
        if: ${{ github.event.inputs.action == 'create' }}
        working-directory: ${{ github.event.inputs.APP_NAME }}
        run: docker build -t ${{ github.event.inputs.DockerHubUser }}/${{ github.event.inputs.APP_NAME }}:${{ github.event.inputs.ImageTag }} .

      # 7Ô∏è‚É£ Docker login
      - name: Docker Login
        if: ${{ github.event.inputs.action == 'create' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

<<<<<<< HEAD
      # 8Ô∏è‚É£ Docker push
      - name: Push Docker Image
        if: ${{ github.event.inputs.action == 'create' }}
        working-directory: ${{ github.event.inputs.APP_NAME }}
        run: docker push ${{ github.event.inputs.DockerHubUser }}/${{ github.event.inputs.APP_NAME }}:${{ github.event.inputs.ImageTag }}
=======
      # 8. Deploy to Kubernetes
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Update kubeconfig for EKS
        run: |
          aws eks update-kubeconfig \
            --region ${{ secrets.AWS_REGION }} \
            --name eks2
>>>>>>> parent of e7189f7 (update main.yml file 12)

      # 9Ô∏è‚É£ Deploy to Kubernetes
      - name: Deploy to Kubernetes
        if: ${{ github.event.inputs.action == 'create' }}
        working-directory: kubernetes
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: |
          sed -i "s|image: .*|image: ${{ github.event.inputs.DockerHubUser }}/${{ github.event.inputs.APP_NAME }}:${{ github.event.inputs.ImageTag }}|" ${{ github.event.inputs.APP_NAME }}-service.yaml
          kubectl apply -f ${{ github.event.inputs.APP_NAME }}-service.yaml

      # üîü Delete Kubernetes service
      - name: Delete Kubernetes Service
        if: ${{ github.event.inputs.action == 'delete' }}
        working-directory: kubernetes
        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}
        run: kubectl delete -f ${{ github.event.inputs.APP_NAME }}-service.yaml